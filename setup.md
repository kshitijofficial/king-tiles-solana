# King Tiles — Quick Setup

This repo has three pieces:

- `programs/king_tiles`: Anchor program (devnet + Magicblock ephemeral execution)
- `relayer.ts` + `relayer/`: Express relayer (starts sessions, delegates board, VRF + scoring + rewards)
- `app/`: React UI

## Prereqs

- **Node.js** (recommended: 18+)
- **Yarn**
- **Rust + Cargo**
- **Solana CLI** (configured for devnet)
- **Anchor CLI**
- A **Solana wallet** (Phantom/Solflare/etc) set to **devnet**

## Install

From repo root:

```bash
yarn
```

Install the web app deps:

```bash
cd app
yarn
```

## Build Anchor IDL/types (required for relayer)

The relayer imports `target/types/king_tiles`, which is generated by Anchor.

From repo root:

```bash
anchor build
```

## Configure env

Create a `.env` in the repo root:

```bash
copy .env.example .env
```

Fill in at least:

- **`TREASURY_SECRET_BASE58` (required)**: base58-encoded private key for the **treasury address** the program expects (must match `TREASURY` on-chain).

Optional (commonly used):

- **`RPC_URL`**: devnet RPC URL (defaults to `https://api.devnet.solana.com`)
- **`KING_TILES_PROGRAM_ID`** or **`PROGRAM_ID`**: override program id (relayer will prefer env override over the IDL address)
- **`PORT`**: relayer port (defaults to `8787`)
- **`ER_ENDPOINT`** / **`ER_WS_ENDPOINT`**: Magicblock endpoints (defaults to devnet endpoints in `relayer/config.ts`)
- **`PLAYER_ONE_PRIVATE_KEY`..`PLAYER_FOUR_PRIVATE_KEY`**: only needed if you want run king_tiles.ts test file to call the relayer `POST /move` endpoint. Not recommended for now (the UI does not use this path by default)

## After you deploy a new program id (important)

If you deploy a **new** program id on devnet, you must update the components that reference it:

- **Relayer**:
  - Set `KING_TILES_PROGRAM_ID=<NEW_PROGRAM_ID>` (or update `PROGRAM_ID`) in the repo root `.env`
  - Restart the relayer
  - Note: if you *don’t* set an override, the relayer uses the program id from `target/idl/king_tiles.json`, so run `anchor build` after changing program id / IDL.
- **Web app**:
  - Set `REACT_APP_PROGRAM_ID=<NEW_PROGRAM_ID>` in `app/.env` (or update the fallback in `app/src/game/constants.ts`)
  - Restart `yarn start`

## Run the relayer

From repo root:

```bash
yarn ts-node -P tsconfig.relayer.json relayer.ts
```

Health check:

- `GET http://localhost:8787/`

## Run the web app

In a second terminal:

```bash
cd app
yarn start
```

The UI expects the relayer at `http://localhost:8787` (see `app/src/game/constants.ts`).

## Start a game

1. Start a session (relayer creates the board on devnet):

```bash
curl -X POST "http://localhost:8787/start-session" -H "Content-Type: application/json" -d "{\"gameId\": 1}"
```

2. Open the UI, connect **two** devnet wallets (e.g., two browsers/profiles), and click **Register** for both.
3. Once the 2nd player registers, the relayer sees `GameStartedEvent`, delegates the board to the ephemeral rollup, and the game runs for ~60s.

## Troubleshooting

- **Relayer says “Missing private key”**: set `TREASURY_SECRET_BASE58` in `.env`.
- **Relayer says treasury mismatch**: your `TREASURY_SECRET_BASE58` must correspond to the fixed treasury pubkey in code.
- **TypeScript import error: `../target/types/king_tiles`**: run `anchor build` from repo root.
- **UI can’t reach relayer**: make sure relayer is running on port `8787` (or update `RELAYER_URL` in `app/src/game/constants.ts`).

